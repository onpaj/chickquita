name: ğŸ§¹ Cleanup

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  cleanup-artifacts:
    name: ğŸ—‘ï¸ Cleanup Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—‘ï¸ Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30); // Keep artifacts for 30 days

            for (const artifact of artifacts.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < cutoffDate) {
                console.log(`Deleting artifact: ${artifact.name} (created: ${artifact.created_at})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
            }

  cleanup-docker-images:
    name: ğŸ³ Cleanup Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—‘ï¸ Delete old staging images
        run: |
          echo "ğŸ” Fetching Docker Hub tags for chickquita..."

          # Use Docker Hub API to list and delete old staging-* tags
          REPO="${{ secrets.DOCKER_USERNAME }}/chickquita"
          TOKEN=$(curl -s -X POST "https://hub.docker.com/v2/users/login" \
            -H "Content-Type: application/json" \
            -d '{"username": "${{ secrets.DOCKER_USERNAME }}", "password": "${{ secrets.DOCKER_PASSWORD }}"}' \
            | jq -r '.token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âš ï¸ Failed to get Docker Hub token, skipping Docker cleanup"
            exit 0
          fi

          # Get all tags
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/$REPO/tags?page_size=100" \
            -H "Authorization: Bearer $TOKEN" | jq -r '.results[].name')

          CUTOFF_DATE=$(date -d "30 days ago" +%s 2>/dev/null || date -v-30d +%s)

          for TAG in $TAGS; do
            # Only delete staging-* tags (never delete v*, latest, sha-*)
            if echo "$TAG" | grep -qE "^staging-"; then
              # Get tag details to check date
              TAG_DATE=$(curl -s "https://hub.docker.com/v2/repositories/$REPO/tags/$TAG" \
                -H "Authorization: Bearer $TOKEN" | jq -r '.last_updated')

              TAG_TIMESTAMP=$(date -d "$TAG_DATE" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${TAG_DATE%%.*}" +%s 2>/dev/null || echo "0")

              if [ "$TAG_TIMESTAMP" -lt "$CUTOFF_DATE" ]; then
                echo "ğŸ—‘ï¸ Deleting old staging image tag: $TAG (updated: $TAG_DATE)"
                curl -s -X DELETE "https://hub.docker.com/v2/repositories/$REPO/tags/$TAG" \
                  -H "Authorization: Bearer $TOKEN"
              else
                echo "âœ… Keeping recent staging tag: $TAG"
              fi
            fi
          done

          echo "âœ… Docker Hub cleanup completed (kept v*, latest, sha-* and recent staging-* tags)"
