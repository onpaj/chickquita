name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Backend Tests Job
  backend-tests:
    name: Backend Tests (.NET)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore backend/Chickquita.slnx

      - name: Build backend
        run: dotnet build backend/Chickquita.slnx --configuration Release --no-restore

      - name: Run backend tests with coverage
        run: dotnet test backend/Chickquita.slnx --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage" --results-directory ./coverage

      - name: Generate backend coverage report
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool || true
          reportgenerator -reports:"coverage/**/coverage.cobertura.xml" -targetdir:"coverage/report" -reporttypes:"Html;Cobertura;TextSummary"
          echo "## Backend Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage/report/Summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check backend coverage threshold
        run: |
          dotnet tool install -g dotnet-coverage || true
          COVERAGE=$(grep -oP 'Line coverage: \K[0-9.]+' coverage/report/Summary.txt || echo "0")
          echo "Backend coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 85" | bc -l) )); then
            echo "::warning::Backend coverage ($COVERAGE%) is below threshold (85%)"
          fi

      - name: Upload backend coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/**/coverage.cobertura.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: |
            **/test-results.trx
            coverage/report/

  # Frontend Tests Job
  frontend-tests:
    name: Frontend Tests (React/Vite)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci --prefer-offline --no-audit

      - name: Run linting
        working-directory: frontend
        run: npm run lint

      - name: Run type check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Run frontend unit tests with coverage
        working-directory: frontend
        run: npm run test:coverage
        env:
          CI: true

      - name: Generate frontend coverage summary
        if: always()
        working-directory: frontend
        run: |
          echo "## Frontend Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if (( $(echo "$LINES < 70" | bc -l) )); then
              echo "::warning::Frontend coverage ($LINES%) is below threshold (70%)"
            fi
          fi

      - name: Upload frontend coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./frontend/coverage/cobertura-coverage.xml,./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Upload frontend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: |
            frontend/coverage/
            frontend/test-results/

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

  # E2E Tests Job
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: frontend-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci --prefer-offline --no-audit

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install chromium --with-deps

      - name: Run E2E tests
        working-directory: frontend
        run: npx playwright test --project=chromium --reporter=html,json,list
        env:
          CI: true
        continue-on-error: false

      - name: Verify test results
        if: always()
        working-directory: frontend
        run: |
          if [ -f playwright-report/results.json ]; then
            FAILED=$(jq '[.suites[].specs[].tests[] | select(.status == "failed")] | length' playwright-report/results.json || echo "0")
            if [ "$FAILED" -gt "0" ]; then
              echo "::error::$FAILED E2E test(s) failed"
              exit 1
            fi
          else
            echo "::error::Test results not found"
            exit 1
          fi

      - name: Generate test summary
        if: always()
        working-directory: frontend
        run: |
          echo "# E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f playwright-report/results.json ]; then
            # Parse JSON results to extract test statistics
            TOTAL=$(jq '.suites | map(.specs | length) | add' playwright-report/results.json || echo "0")
            PASSED=$(jq '[.suites[].specs[].tests[] | select(.status == "passed")] | length' playwright-report/results.json || echo "0")
            FAILED=$(jq '[.suites[].specs[].tests[] | select(.status == "failed")] | length' playwright-report/results.json || echo "0")
            SKIPPED=$(jq '[.suites[].specs[].tests[] | select(.status == "skipped")] | length' playwright-report/results.json || echo "0")

            echo "## Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## DailyRecords Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All DailyRecords E2E tests have been executed." >> $GITHUB_STEP_SUMMARY
          echo "- daily-records-quick-add.spec.ts" >> $GITHUB_STEP_SUMMARY
          echo "- daily-records-list.spec.ts" >> $GITHUB_STEP_SUMMARY
          echo "- daily-records-edit.spec.ts" >> $GITHUB_STEP_SUMMARY
          echo "- daily-records-full-workflow.spec.ts" >> $GITHUB_STEP_SUMMARY
          echo "- daily-records-quick-add-performance.spec.ts" >> $GITHUB_STEP_SUMMARY
          echo "- daily-records-mobile-ui.spec.ts" >> $GITHUB_STEP_SUMMARY
          echo "- daily-records-accessibility.spec.ts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full test report available in artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 30

      - name: Upload test report for PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-html-report
          path: frontend/playwright-report/
          retention-days: 14

      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let comment = '## ðŸŽ­ E2E Test Results\n\n';

            const resultsPath = path.join(process.env.GITHUB_WORKSPACE, 'frontend/playwright-report/results.json');
            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              const stats = results.suites.reduce((acc, suite) => {
                suite.specs.forEach(spec => {
                  spec.tests.forEach(test => {
                    acc[test.status] = (acc[test.status] || 0) + 1;
                  });
                });
                return acc;
              }, {});

              comment += '| Status | Count |\n';
              comment += '|--------|-------|\n';
              comment += `| âœ… Passed | ${stats.passed || 0} |\n`;
              comment += `| âŒ Failed | ${stats.failed || 0} |\n`;
              comment += `| â­ï¸ Skipped | ${stats.skipped || 0} |\n`;
              comment += '\n';

              if (stats.failed > 0) {
                comment += '### âŒ Failed Tests\n\n';
                results.suites.forEach(suite => {
                  suite.specs.forEach(spec => {
                    spec.tests.forEach(test => {
                      if (test.status === 'failed') {
                        comment += `- ${spec.title}: ${test.projectName}\n`;
                      }
                    });
                  });
                });
                comment += '\n';
              }
            }

            comment += 'Full HTML report available in workflow artifacts.\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Coverage Check Job
  coverage-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-test-results
          path: backend-coverage

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-test-results
          path: frontend-coverage

      - name: Check coverage thresholds
        run: |
          echo "## Coverage Threshold Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PASS=true

          # Check backend coverage
          if [ -f backend-coverage/report/Summary.txt ]; then
            BACKEND_COV=$(grep -oP 'Line coverage: \K[0-9.]+' backend-coverage/report/Summary.txt || echo "0")
            echo "Backend coverage: $BACKEND_COV%" >> $GITHUB_STEP_SUMMARY
            if (( $(echo "$BACKEND_COV < 85" | bc -l) )); then
              echo "::error::Backend coverage ($BACKEND_COV%) is below required threshold (85%)"
              PASS=false
            fi
          else
            echo "::warning::Backend coverage report not found"
          fi

          # Check frontend coverage
          if [ -f frontend-coverage/coverage-summary.json ]; then
            FRONTEND_COV=$(jq -r '.total.lines.pct' frontend-coverage/coverage-summary.json)
            echo "Frontend coverage: $FRONTEND_COV%" >> $GITHUB_STEP_SUMMARY
            if (( $(echo "$FRONTEND_COV < 70" | bc -l) )); then
              echo "::error::Frontend coverage ($FRONTEND_COV%) is below required threshold (70%)"
              PASS=false
            fi
          else
            echo "::warning::Frontend coverage report not found"
          fi

          if [ "$PASS" = false ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Coverage checks failed. Please increase test coverage." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All coverage thresholds met." >> $GITHUB_STEP_SUMMARY
          fi

  # Docker Build Job
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Docker Push Job (only on main branch)
  docker-push:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.meta.outputs.digest }}
          push-to-registry: true
